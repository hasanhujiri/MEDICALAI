<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medical AI Hub</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f9fc;
      min-height: 100vh;
    }

    .sidebar {
      width: 280px;
      background-color: #ffffff;
      border-right: 1px solid #e5e7eb;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                  0 2px 4px -2px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 1rem 1.5rem;
      margin: 0.5rem 0;
      cursor: pointer;
      border-radius: 0.75rem;
      transition: all 0.2s;
      font-weight: 500;
    }

    .nav-item:hover { background-color: #f3f4f6; }

    .nav-item.active {
      background-color: #3b82f6;
      color: white;
      box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.5),
                  0 4px 6px -2px rgba(59, 130, 246, 0.05);
    }

    .nav-item:not(.active) i { color: #6b7280; }
    .nav-item.active i { color: white; }

    .drag-drop-area {
      border: 2px dashed #93c5fd;
      background-color: #eff6ff;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .drag-drop-area:hover { border-color: #3b82f6; }

    .report-section { padding: 1rem; border-bottom: 1px solid #e5e7eb; }
    .report-section:last-child { border-bottom: none; }

    .image-gallery {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      padding: 0.5rem;
      background-color: #f3f4f6;
      border-radius: 0.5rem;
      min-height: 120px;
    }

    .gallery-thumbnail {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 0.5rem;
      border: 2px solid #d1d5db;
      flex-shrink: 0;
    }

    @media (max-width: 1023px) {
      .main-content { max-width: 100%; padding: 1rem; }
    }
  </style>
</head>

<body class="min-h-screen bg-slate-50">
  <!-- Mobile Header -->
  <header class="lg:hidden sticky top-0 z-40 bg-white border-b border-slate-200">
    <div class="flex items-center justify-between px-4 py-3">
      <button id="mobileMenuBtn" class="p-2 rounded-md border border-slate-200" aria-label="Open menu">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="3" y1="6" x2="21" y2="6" />
          <line x1="3" y1="12" x2="21" y2="12" />
          <line x1="3" y1="18" x2="21" y2="18" />
        </svg>
      </button>
      <h1 class="text-lg font-semibold text-slate-900">Medical AI Hub</h1>
      <span class="w-8"></span>
    </div>
  </header>

  <div class="flex">
    <!-- Sidebar as mobile drawer -->
    <aside id="mobileDrawer" class="sidebar fixed inset-y-0 left-0 z-50 w-72 bg-white border-r border-slate-200 shadow-xl transform -translate-x-full transition-transform duration-200 ease-out lg:translate-x-0 lg:static lg:shadow-none lg:w-[280px] p-6 flex flex-col justify-between">
      <div>
        <h1 class="text-2xl font-extrabold text-gray-900 mb-6 hidden lg:block">Medical AI Hub</h1>
        <nav id="nav-container">
          <div class="nav-item active" data-view="image-analysis">
            <i data-lucide="scan" class="w-5 h-5 mr-3"></i> AI Image Analysis
          </div>
          <div class="nav-item text-gray-600" data-view="knowledge-base">
            <i data-lucide="book-open-text" class="w-5 h-5 mr-3"></i> Knowledge Base
          </div>
          <div class="nav-item text-gray-600" data-view="communication">
            <i data-lucide="messages-square" class="w-5 h-5 mr-3"></i> Communication Drafting
          </div>
        </nav>
      </div>

      <!-- Error message -->
      <div id="errorMessage" class="hidden fixed bottom-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50" role="alert">
        <p class="font-bold" id="errorTitle">Something went wrong</p>
        <p class="text-sm" id="errorDetail">There was a problem running your code.</p>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main-content w-full px-4 sm:px-6 lg:px-12 py-6 lg:py-12">
      <h2 id="mainTitle" class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 mb-4 lg:mb-8">AI Image Analysis</h2>

      <div id="viewContainer">
        <!-- AI IMAGE ANALYSIS -->
        <div id="image-analysis-view" class="grid gap-6 sm:gap-8 md:grid-cols-1 lg:grid-cols-2 view-content">
          <!-- Left: inputs -->
          <div class="bg-white p-4 sm:p-6 lg:p-8 rounded-xl shadow-lg h-full">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Image Input</h3>

            <div id="dropArea" class="drag-drop-area mb-4 p-6" onclick="document.getElementById('fileInput').click()">
              <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect(event)" multiple>
              <i data-lucide="upload" class="w-8 h-8 text-blue-500 mb-2"></i>
              <p class="text-blue-700 font-medium">Upload Images (X-Ray, CT, MRI series)</p>
              <p class="text-sm text-gray-500 mt-1">Click to select or drag and drop files here</p>
            </div>

            <div id="imagePreviewContainer" class="hidden mb-4 sm:mb-6">
              <p class="text-sm font-medium text-gray-700 mb-2">Uploaded Images:</p>
              <div id="imageGallery" class="image-gallery max-w-full overflow-x-auto"></div>
            </div>

            <label for="promptInput" class="block text-sm font-medium text-gray-700 mb-2">Analysis Prompt</label>
            <textarea id="promptInput" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition resize-none" placeholder="Analyze the image series for radiological findings. Provide a structured JSON with 'impression', 'findings', 'recommendations', and 'severity'."></textarea>

            <div class="mt-6">
              <button onclick="runAnalysis()" id="runButton" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition shadow-lg disabled:opacity-50" disabled>
                Run AI Analysis <i data-lucide="sparkles" class="w-4 h-4 ml-2 inline-block"></i>
              </button>
            </div>

            <div id="imageAnalysisLoadingIndicator" class="mt-4 text-center text-blue-600 font-medium hidden">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Analyzing images...
            </div>
          </div>

          <!-- Right: output -->
          <div class="bg-white rounded-xl shadow-lg h-full overflow-hidden">
            <div id="reportHeader" class="p-6 transition duration-300 bg-gray-100">
              <h3 class="text-xl font-semibold mb-1 text-gray-800">Structured Report</h3>
              <p id="severityDisplay" class="text-sm font-medium text-gray-500">Severity: Awaiting Analysis</p>
            </div>

            <div id="imageReportOutput" class="min-h-[260px] sm:min-h-[320px] lg:min-h-[400px] bg-gray-50 p-3 sm:p-4 border-t border-gray-200 overflow-y-auto rounded-b-lg">
              <p class="text-gray-500 italic p-2">Upload one or more images and click "Run AI Analysis" to generate a structured radiological report.</p>
            </div>

            <div class="p-6 pt-0">
              <button onclick="copyReport()" id="copyButton" class="w-full mt-3 bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition shadow-lg hidden">
                Copy Report Text (JSON)
              </button>
            </div>
          </div>
        </div>

        <!-- KNOWLEDGE BASE -->
        <div id="knowledge-base-view" class="hidden view-content">
          <div class="grid gap-6 sm:gap-8 md:grid-cols-1 lg:grid-cols-2">
            <div class="bg-white p-4 sm:p-6 lg:p-8 rounded-xl shadow-lg">
              <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Search Medical Literature (Grounding)</h3>
              <label for="kbQuery" class="block text-sm font-medium text-gray-700 mb-2">Enter Medical Query</label>
              <textarea id="kbQuery" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition resize-none" placeholder="e.g., What is the standard treatment for stage II NSCLC?"></textarea>
              <button onclick="runKnowledgeBaseSearch()" id="kbSearchButton" class="w-full mt-6 bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition shadow-lg">
                Search Medical Knowledge <i data-lucide="search" class="w-4 h-4 ml-2 inline-block"></i>
              </button>
              <div id="kbLoadingIndicator" class="mt-4 text-center text-indigo-600 font-medium hidden">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Searching...
              </div>
            </div>
            <div class="bg-white p-4 sm:p-6 lg:p-8 rounded-xl shadow-lg">
              <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Grounding Results</h3>
              <div id="kbOutput" class="min-h-[400px] bg-gray-50 p-4 rounded-lg border border-gray-200 overflow-y-auto">
                <p class="text-gray-500 italic">Results from medical literature searches will appear here, with citations.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- COMMUNICATION DRAFTING -->
        <div id="communication-view" class="hidden view-content">
          <div class="grid gap-6 sm:gap-8 md:grid-cols-1 lg:grid-cols-2">
            <div class="bg-white p-4 sm:p-6 lg:p-8 rounded-xl shadow-lg">
              <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Drafting Parameters</h3>

              <div id="dictationBanner" class="hidden mb-4 p-3 bg-red-100 border border-red-300 text-red-800 rounded-lg text-center text-sm font-medium">
                🔴 Dictation is active. Click the square to stop.
              </div>

              <div class="space-y-4">
                <div>
                  <label for="draftRecipient" class="block text-sm font-medium text-gray-700">Communication Type</label>
                  <select id="draftRecipient" onchange="handleDraftRecipientChange(this.value)" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    <option value="Referring Physician Update">Referring Physician Update/Referral</option>
                    <option value="Patient Follow-up">Patient Follow-up/Education</option>
                    <option value="Radiology Report Draft" selected>Radiology Report Draft</option>
                    <option value="Clinic Administrator">Clinic Administrator Request/Report</option>
                  </select>
                </div>

                <div>
                  <label for="draftTopic" class="block text-sm font-medium text-gray-700">Communication Topic/Details</label>
                  <div class="flex items-end gap-2 flex-wrap">
                    <textarea id="draftTopic" rows="5" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition resize-none" placeholder="e.g., Patient is J. Doe. Needs urgent consultation..."></textarea>
                    <button onclick="toggleDictation()" id="dictationButton" class="mic-btn w-full sm:w-auto p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 shadow-md" data-recording="false" title="Start Dictation"></button>
                  </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                  <div class="flex-1">
                    <label for="draftUrgency" class="block text-sm font-medium text-gray-700">Urgency</label>
                    <select id="draftUrgency" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                      <option value="Urgent">Urgent</option>
                      <option value="Standard">Standard</option>
                      <option value="Routine">Routine</option>
                    </select>
                  </div>
                  <div class="flex-1">
                    <label for="draftFormat" class="block text-sm font-medium text-gray-700">Format/Length</label>
                    <select id="draftFormat" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                      <option value="Short Email">Short Email</option>
                      <option value="Detailed Letter">Detailed Letter</option>
                      <option value="Progress Note">Progress Note</option>
                      <option value="Report (Long)">Report (Long)</option>
                    </select>
                  </div>
                </div>
              </div>

              <button onclick="draftCommunication()" id="draftButton" class="w-full mt-6 bg-teal-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-teal-700 transition shadow-lg">
                Generate Draft <i data-lucide="file-text" class="w-4 h-4 ml-2 inline-block"></i>
              </button>
              <div id="draftLoadingIndicator" class="mt-4 text-center text-teal-600 font-medium hidden">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-teal-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Drafting communication...
              </div>
            </div>

            <div class="bg-white p-4 sm:p-6 lg:p-8 rounded-xl shadow-lg">
              <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Generated Draft</h3>
              <div id="draftOutput" class="min-h-[400px] bg-gray-50 p-4 rounded-lg border border-gray-200 overflow-y-auto whitespace-pre-wrap text-gray-800">
                <p class="text-gray-500 italic">Configure the parameters and click 'Generate Draft' to create a professional communication.</p>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- /viewContainer -->
    </main>
  </div> <!-- /layout -->

  <!-- App Logic -->
  <script type="module">
    // IMPORTANT: Replace the direct Gemini API call with your backend proxy in production.
    // const apiUrl = 'http://localhost:3000/api/generate';
    const GEMINI_API_KEY = "AIzaSyA0yEml30Y1NItvJ5hZoLKi0EnMTLIgNng"; // Remove when proxying through backend.
    const MODEL_NAME = "gemini-2.0-flash";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`;

    // Minimal placeholders for Firebase (optional)
    async function initializeFirebase() {
      // No-op here; plug in actual Firebase init if required.
      return;
    }

    // State
    let imageBase64Data = []; // array of { mimeType, data }
    let recognition = null;
    let isRecording = false;
    let finalTranscript = '';

    // Elements
    const navContainer = document.getElementById('nav-container');
    const mainTitle = document.getElementById('mainTitle');
    const viewContainer = document.getElementById('viewContainer');
    const fileInput = document.getElementById('fileInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imageGallery = document.getElementById('imageGallery');
    const promptInput = document.getElementById('promptInput');
    const runButton = document.getElementById('runButton');
    const imageAnalysisLoadingIndicator = document.getElementById('imageAnalysisLoadingIndicator');
    const imageReportOutput = document.getElementById('imageReportOutput');
    const reportHeader = document.getElementById('reportHeader');
    const severityDisplay = document.getElementById('severityDisplay');
    const copyButton = document.getElementById('copyButton');
    const kbSearchButton = document.getElementById('kbSearchButton');
    const kbLoadingIndicator = document.getElementById('kbLoadingIndicator');
    const kbOutput = document.getElementById('kbOutput');
    const draftRecipientSelect = document.getElementById('draftRecipient');
    const dictationButton = document.getElementById('dictationButton');
    const dictationBanner = document.getElementById('dictationBanner');
    const draftButton = document.getElementById('draftButton');
    const draftLoadingIndicator = document.getElementById('draftLoadingIndicator');
    const draftOutput = document.getElementById('draftOutput');
    const errorTitle = document.getElementById('errorTitle');
    const errorDetail = document.getElementById('errorDetail');
    const errorMessage = document.getElementById('errorMessage');

    const micIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>`;
    const stopIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12" rx="2"></rect></svg>`;

    // Utility
    function displayError(title, detail) {
      errorTitle.textContent = title;
      errorDetail.textContent = detail;
      errorMessage.classList.remove('hidden');
      setTimeout(() => errorMessage.classList.add('hidden'), 5000);
    }

    function getBackoffDelay(attempt) {
      return Math.min(30000, (2 ** attempt) * 1000);
    }

    // View switching
    function switchView(viewName) {
      document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
      const targetView = document.getElementById(`${viewName}-view`);
      if (targetView) targetView.classList.remove('hidden');

      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active', 'text-gray-600');
        if (item.getAttribute('data-view') !== viewName) item.classList.add('text-gray-600');
      });
      const activeItem = document.querySelector(`.nav-item[data-view="${viewName}"]`);
      if (activeItem) activeItem.classList.add('active');

      const titleMap = {
        'image-analysis': 'AI Image Analysis',
        'knowledge-base': 'Medical Knowledge Base',
        'communication': 'Communication Drafting'
      };
      mainTitle.textContent = titleMap[viewName] || 'Medical AI Hub';

      if (viewName === 'communication') {
        handleDraftRecipientChange(draftRecipientSelect.value);
      } else if (isRecording) {
        stopDictation();
      }
    }

    // File handling
    window.handleFileSelect = function (event) {
      const files = event.target.files;
      if (!files || files.length === 0) {
        imageBase64Data = [];
        runButton.disabled = true;
        imagePreviewContainer.classList.add('hidden');
        imageGallery.innerHTML = '';
        return;
      }
      imageBase64Data = [];
      imageGallery.innerHTML = '';
      imagePreviewContainer.classList.remove('hidden');
      runButton.disabled = false;

      Array.from(files).forEach(file => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const base64 = e.target.result;
          imageBase64Data.push({ mimeType: file.type, data: base64.split(',')[1] });

          const img = document.createElement('img');
          img.src = base64;
          img.className = 'gallery-thumbnail';
          img.alt = file.name;
          imageGallery.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    // Dictation
    function startDictation() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        displayError("Browser Not Supported", "Speech recognition is not available in this browser.");
        return;
      }
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';
      finalTranscript = document.getElementById('draftTopic').value;

      recognition.onstart = () => {
        isRecording = true;
        dictationButton.innerHTML = stopIconSVG;
        dictationButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        dictationButton.classList.add('bg-red-600', 'hover:bg-red-700', 'animate-pulse');
      };
      recognition.onresult = (event) => {
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript + ' ';
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        const ta = document.getElementById('draftTopic');
        ta.value = finalTranscript + interimTranscript;
        ta.scrollTop = ta.scrollHeight;
      };
      recognition.onerror = (event) => {
        displayError("Dictation Error", `Error: ${event.error}. Please try again.`);
        stopDictation();
      };
      recognition.onend = () => {
        if (isRecording) stopDictation();
      };
      recognition.start();
    }

    function stopDictation() {
      if (recognition) recognition.stop();
      isRecording = false;
      dictationButton.innerHTML = micIconSVG;
      dictationButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'animate-pulse');
      dictationButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }

    window.toggleDictation = function () {
      if (isRecording) stopDictation();
      else startDictation();
    }

    window.handleDraftRecipientChange = function (val) {
      if (val === 'Radiology Report Draft') {
        dictationButton.classList.remove('hidden');
      } else {
        dictationButton.classList.add('hidden');
        if (isRecording) stopDictation();
      }
    }

    // Analysis
    window.runAnalysis = async function () {
      if (!apiUrl.includes('http')) {
        displayError("API URL Missing", "Please configure the API endpoint.");
        return;
      }
      if (apiUrl.includes('key=PASTE_YOUR_GEMINI_API_KEY_HERE')) {
        displayError("API Key Missing", "Use a backend proxy or add a valid key for testing.");
        return;
      }
      if (imageBase64Data.length === 0) {
        displayError("No Images Selected", "Please upload one or more medical images.");
        return;
      }

      const systemPrompt = "You are a specialized medical imaging AI. Analyze the uploaded series and the user's prompt to generate a consolidated, structured radiological report. Severity must be one of: 'Normal Findings', 'Minor Findings', or 'Critical Findings'.";
      const userPrompt = promptInput.value.trim();

      runButton.disabled = true;
      runButton.textContent = "Analyzing...";
      imageAnalysisLoadingIndicator.classList.remove('hidden');
      imageReportOutput.innerHTML = `<p class="text-gray-500 italic p-2">Sending ${imageBase64Data.length} images to AI...</p>`;
      copyButton.classList.add('hidden');
      reportHeader.className = 'p-6 transition duration-300 bg-gray-100 text-gray-800';
      severityDisplay.textContent = 'Severity: Processing...';

      const apiParts = [{ text: userPrompt }];
      imageBase64Data.forEach(img => {
        apiParts.push({ inlineData: { mimeType: img.mimeType, data: img.data } });
      });

      const reportSchema = {
        type: "OBJECT",
        properties: {
          impression: { type: "STRING" },
          findings: { type: "STRING" },
          recommendations: { type: "STRING" },
          severity: { type: "STRING" },
        },
        required: ["impression", "findings", "recommendations", "severity"],
        propertyOrdering: ["impression", "findings", "recommendations", "severity"]
      };

      const payload = {
        contents: [{ role: "user", parts: apiParts }],
        generationConfig: { responseMimeType: "application/json", responseSchema: reportSchema },
        systemInstruction: { parts: [{ text: systemPrompt }] }
      };

      const maxRetries = 5;
      let attempt = 0;
      try {
        while (attempt < maxRetries) {
          attempt++;
          try {
            const resp = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (resp.status === 429 && attempt < maxRetries) {
              await new Promise(r => setTimeout(r, getBackoffDelay(attempt)));
              continue;
            }
            if (!resp.ok) {
              const body = await resp.text();
              throw new Error(`API error ${resp.status}: ${body}`);
            }
            const data = await resp.json();
            const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("Empty AI response.");
            const reportJson = JSON.parse(text);

            // Render
            function setSeverity(s) {
              const lower = (s || '').toLowerCase();
              if (lower.includes('normal')) return ['bg-green-100 text-green-800', 'text-green-700', 'Severity: Normal Findings'];
              if (lower.includes('minor')) return ['bg-yellow-100 text-yellow-800', 'text-yellow-700', 'Severity: Minor Findings'];
              if (lower.includes('critical')) return ['bg-red-100 text-red-800', 'text-red-700', 'Severity: Critical Findings'];
              return ['bg-gray-100 text-gray-800', 'text-gray-700', 'Severity: Unclassified'];
            }
            const [hdrClass, txtClass, txt] = setSeverity(reportJson.severity);
            reportHeader.className = `p-6 transition duration-300 ${hdrClass}`;
            severityDisplay.className = `text-sm font-bold ${txtClass}`;
            severityDisplay.textContent = txt;

            const sections = [
              { key: 'impression', title: 'Impression' },
              { key: 'findings', title: 'Findings' },
              { key: 'recommendations', title: 'Recommendations' },
            ];
            let html = '';
            for (const s of sections) {
              const content = reportJson[s.key] || 'N/A';
              html += `
                <div class="report-section">
                  <h4 class="text-lg font-bold text-blue-700 mb-2">${s.title}</h4>
                  <p class="text-gray-800 whitespace-pre-wrap">${content}</p>
                </div>`;
            }
            imageReportOutput.innerHTML = html;
            copyButton.dataset.reportText = JSON.stringify(reportJson, null, 2);
            copyButton.classList.remove('hidden');
            break;
          } catch (err) {
            if (attempt >= maxRetries) throw err;
            await new Promise(r => setTimeout(r, getBackoffDelay(attempt)));
          }
        }
      } catch (e) {
        imageReportOutput.innerHTML = `<p class="text-red-600 font-bold p-2">Error: ${e.message}</p>`;
        displayError("Analysis Failed", e.message);
      } finally {
        runButton.disabled = false;
        runButton.innerHTML = `Run AI Analysis <i data-lucide="sparkles" class="w-4 h-4 ml-2 inline-block"></i>`;
        imageAnalysisLoadingIndicator.classList.add('hidden');
        if (window.lucide) lucide.createIcons();
      }
    }

    window.copyReport = function () {
      const txt = copyButton.dataset.reportText;
      if (!txt) return;
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      copyButton.textContent = 'Copied!';
      setTimeout(() => copyButton.textContent = 'Copy Report Text (JSON)', 1500);
    }

    // Knowledge Base
    window.runKnowledgeBaseSearch = async function () {
      if (!apiUrl.includes('http')) {
        displayError("API URL Missing", "Please configure the API endpoint.");
        return;
      }
      const q = document.getElementById('kbQuery').value.trim();
      if (!q) {
        displayError("Empty Query", "Please enter a medical query.");
        return;
      }
      kbSearchButton.disabled = true;
      kbSearchButton.textContent = "Searching...";
      kbLoadingIndicator.classList.remove('hidden');
      kbOutput.innerHTML = `<p class="text-gray-500 italic">Searching: "${q}"...</p>`;

      const systemPrompt = "You are a medical literature search assistant. Only answer medicine/biology/healthcare questions; otherwise politely decline.";
      const payload = {
        contents: [{ parts: [{ text: q }] }],
        tools: [{ "googleSearch": {} }],
        systemInstruction: { parts: [{ text: systemPrompt }] }
      };

      try {
        const resp = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!resp.ok) throw new Error(`API error ${resp.status}`);
        const data = await resp.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'No answer.';
        const atts = data?.candidates?.[0]?.groundingMetadata?.groundingAttributions || [];
        let sources = atts.map(a => ({ uri: a.web?.uri, title: a.web?.title })).filter(s => s.uri && s.title);
        let html = `<div>${text.replace(/\n/g, '<br>')}</div>`;
        if (sources?.length) {
          html += `<div class="mt-4 pt-4 border-t border-gray-300"><h5 class="font-semibold text-sm mb-2 text-indigo-700">Cited Sources</h5>`;
          sources.forEach((s, i) => { html += `<p class="text-xs text-gray-600 mb-1"><a href="${s.uri}" target="_blank" class="text-blue-600 hover:underline">${i + 1}. ${s.title}</a></p>`; });
          html += `</div>`;
        }
        kbOutput.innerHTML = html;
      } catch (e) {
        kbOutput.innerHTML = `<p class="text-red-600 font-bold">Error: ${e.message}</p>`;
        displayError("Search Failed", e.message);
      } finally {
        kbSearchButton.disabled = false;
        kbSearchButton.innerHTML = `Search Medical Knowledge <i data-lucide="search" class="w-4 h-4 ml-2 inline-block"></i>`;
        kbLoadingIndicator.classList.add('hidden');
        if (window.lucide) lucide.createIcons();
      }
    }

    window.draftCommunication = async function () {
      if (!apiUrl.includes('http')) {
        displayError("API URL Missing", "Please configure the API endpoint.");
        return;
      }
      if (isRecording) stopDictation();

      const draftRecipient = document.getElementById('draftRecipient').value;
      const draftTopic = document.getElementById('draftTopic').value.trim();
      const draftUrgency = document.getElementById('draftUrgency').value;
      const draftFormat = document.getElementById('draftFormat').value;

      if (!draftTopic) {
        displayError("Missing Details", "Please provide the communication topic.");
        return;
      }

      draftButton.disabled = true;
      draftButton.textContent = "Drafting...";
      draftLoadingIndicator.classList.remove('hidden');
      draftOutput.innerHTML = `<p class="text-gray-500 italic">Generating ${draftFormat} for ${draftRecipient}...</p>`;

      const systemPrompt = "You are a professional medical administrative assistant and report writer. Draft clear, concise, professional communications. Output only the body.";
      const userQuery = `Draft an ${draftUrgency} ${draftFormat} for ${draftRecipient}. Details: "${draftTopic}". Use an appropriate tone.`;

      const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        tools: [{ "googleSearch": {} }],
        systemInstruction: { parts: [{ text: systemPrompt }] }
      };

      try {
        const resp = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!resp.ok) throw new Error(`API error ${resp.status}`);
        const data = await resp.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'No draft generated.';
        draftOutput.innerHTML = text.replace(/\n/g, '<br>');
      } catch (e) {
        draftOutput.innerHTML = `<p class="text-red-600 font-bold">Error: ${e.message}</p>`;
        displayError("Drafting Failed", e.message);
      } finally {
        draftButton.disabled = false;
        draftButton.innerHTML = `Generate Draft <i data-lucide="file-text" class="w-4 h-4 ml-2 inline-block"></i>`;
        draftLoadingIndicator.classList.add('hidden');
        if (window.lucide) lucide.createIcons();
      }
    }

    // Initialization (single flow)
    window.addEventListener('load', async () => {
      // Icons
      if (window.lucide) lucide.createIcons();

      // Firebase (if used)
      await initializeFirebase();

      // Default prompt
      promptInput.value = "Analyze the image series for radiological findings. Provide a structured JSON with fields: impression, findings, recommendations, and severity. Ensure severity reflects the overall study as 'Normal Findings', 'Minor Findings', or 'Critical Findings'.";

      // Drag & drop
      const dropArea = document.getElementById('dropArea');
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => dropArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); }, false));
      dropArea.addEventListener('drop', (e) => {
        if (e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          fileInput.dispatchEvent(new Event('change'));
        }
      });

      // Navigation delegation
      if (navContainer) {
        navContainer.addEventListener('click', (e) => {
          const item = e.target.closest('.nav-item');
          if (!item) return;
          const view = item.getAttribute('data-view');
          if (!view) return;
          switchView(view);
          // Close drawer on mobile
          const drawer = document.getElementById('mobileDrawer');
          if (window.innerWidth < 1024 && drawer) drawer.classList.add('-translate-x-full');
        });
      }

      // Dictation icon
      dictationButton.innerHTML = micIconSVG;
      handleDraftRecipientChange(draftRecipientSelect.value);

      // Default view
      switchView('image-analysis');
    });

    // Mobile drawer: separate load-safe binding (does not override onload)
    window.addEventListener('load', () => {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileDrawer = document.getElementById('mobileDrawer');
      if (mobileMenuBtn && mobileDrawer) {
        mobileMenuBtn.addEventListener('click', () => {
          mobileDrawer.classList.toggle('-translate-x-full');
        });
        window.addEventListener('resize', () => {
          if (window.innerWidth >= 1024) mobileDrawer.classList.remove('-translate-x-full');
          else mobileDrawer.classList.add('-translate-x-full');
        });
      }
    });
  </script>
</body>
</html>
