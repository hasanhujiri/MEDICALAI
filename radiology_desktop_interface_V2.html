<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical AI Hub</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
        }
        .sidebar {
            width: 280px;
            background-color: #ffffff;
            border-right: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            height: 100vh;
        }
        .main-content {
            flex-grow: 1;
            padding: 3rem;
            max-width: calc(100% - 280px);
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            margin: 0.5rem 0;
            cursor: pointer;
            border-radius: 0.75rem;
            transition: all 0.2s;
            font-weight: 500;
        }
        .nav-item:hover {
            background-color: #f3f4f6;
        }
        .nav-item.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.5), 0 4px 6px -2px rgba(59, 130, 246, 0.05);
        }
        .nav-item:not(.active) i {
            color: #6b7280; /* gray-500 */
        }
        .nav-item.active i {
            color: white;
        }
        .drag-drop-area {
            border: 2px dashed #93c5fd;
            background-color: #eff6ff;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .drag-drop-area:hover {
            border-color: #3b82f6;
        }
        .report-section {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .report-section:last-child {
            border-bottom: none;
        }
        .chat-message {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        .user-message {
            background-color: #dbeafe; /* blue-100 */
            align-self: flex-end;
            margin-left: auto;
        }
        .ai-message {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            align-self: flex-start;
            margin-right: auto;
        }
        .chat-container {
            height: calc(100vh - 270px); /* Adjusted for headers and input */
            overflow-y: auto;
        }
    </style>
    <!-- Lucide icons for visual elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="flex">

    <!-- Sidebar Navigation -->
    <div class="sidebar p-6 flex flex-col justify-between">
        <div>
            <h1 class="text-3xl font-extrabold text-gray-900 mb-10">Medical AI Hub</h1>
            <nav id="nav-container">
                <div class="nav-item active" data-view="image-analysis">
                    <i data-lucide="scan" class="w-5 h-5 mr-3"></i>
                    AI Image Analysis
                </div>
                <div class="nav-item text-gray-600" data-view="knowledge-base">
                    <i data-lucide="book-open-text" class="w-5 h-5 mr-3"></i>
                    Knowledge Base
                </div>
                <div class="nav-item text-gray-600" data-view="doctor-ai">
                    <i data-lucide="stethoscope" class="w-5 h-5 mr-3"></i>
                    General Doctor AI
                </div>
                <div class="nav-item text-gray-600" data-view="communication">
                    <i data-lucide="messages-square" class="w-5 h-5 mr-3"></i>
                    Communication Drafting
                </div>
            </nav>
        </div>
        <!-- Footer Info Block -->
        <div class="p-4 bg-slate-50 rounded-lg text-xs text-gray-600 mt-8">
            <p class="mb-1">User ID: <span id="userIdDisplay" class="font-mono font-semibold text-gray-800">Loading...</span></p>
            <p>App ID: <span id="appIdDisplay" class="font-mono text-gray-500">Loading...</span></p>
        </div>
        <!-- Error Message Placeholder -->
        <div id="errorMessage" class="hidden fixed bottom-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50" role="alert">
            <p class="font-bold" id="errorTitle">Something went wrong</p>
            <p class="text-sm" id="errorDetail">There was a problem running your code.</p>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <h2 id="mainTitle" class="text-4xl font-bold text-gray-900 mb-8">AI Image Analysis</h2>

        <!-- All views are contained here. Only the active view will be displayed via JS. -->
        <div id="viewContainer">

            <!-- ======================================================================= -->
            <!-- 1. AI IMAGE ANALYSIS VIEW -->
            <!-- ======================================================================= -->
            <div id="image-analysis-view" class="grid lg:grid-cols-2 gap-8 view-content">
                <!-- Input Panel (Left) -->
                <div class="bg-white p-8 rounded-xl shadow-lg h-full">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Image Input</h3>
                    
                    <!-- File Upload/Drag and Drop Area -->
                    <div id="dropArea" class="drag-drop-area mb-4 p-6" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                        <i data-lucide="upload" class="w-8 h-8 text-blue-500 mb-2"></i>
                        <p class="text-blue-700 font-medium">Upload Image (X-Ray, CT, etc.)</p>
                        <p class="text-sm text-gray-500 mt-1">Click to select or drag and drop here</p>
                    </div>
                    
                    <!-- Image Preview -->
                    <div id="imagePreviewContainer" class="hidden mb-6">
                        <img id="imagePreview" class="w-full max-h-72 object-contain rounded-lg border border-gray-300 bg-gray-100" alt="Image Preview">
                    </div>

                    <!-- Text Prompt Input -->
                    <label for="promptInput" class="block text-sm font-medium text-gray-700 mb-2">Analysis Prompt:</label>
                    <textarea id="promptInput" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition resize-none" placeholder="Analyze the following image for radiological findings. Provide a structured JSON output with fields 'impression', 'findings', and 'recommendations'"></textarea>

                    <!-- Run Button -->
                    <button onclick="runAnalysis()" id="runButton" class="w-full mt-6 bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition shadow-lg transform hover:scale-[1.01]" disabled>
                        Run AI Analysis <i data-lucide="sparkles" class="w-4 h-4 ml-2 inline-block"></i>
                    </button>
                    <div id="imageAnalysisLoadingIndicator" class="mt-4 text-center text-blue-600 font-medium hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Analyzing image...
                    </div>
                </div>

                <!-- Output Panel (Right) -->
                <div class="bg-white p-8 rounded-xl shadow-lg h-full">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Structured Report</h3>
                    <div id="imageReportOutput" class="min-h-[400px] bg-gray-50 p-4 rounded-lg border border-gray-200 overflow-y-auto">
                        <p class="text-gray-500 italic">Upload an image and click "Run AI Analysis" to generate a structured radiological report.</p>
                    </div>
                    <button onclick="copyReport()" id="copyButton" class="w-full mt-6 bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition shadow-lg hidden">
                        Copy Report Text (JSON)
                    </button>
                </div>
            </div>

            <!-- ======================================================================= -->
            <!-- 2. KNOWLEDGE BASE VIEW -->
            <!-- ======================================================================= -->
            <div id="knowledge-base-view" class="hidden view-content">
                <div class="lg:grid lg:grid-cols-2 lg:gap-8">
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Search Medical Literature (Grounding)</h3>
                        <label for="kbQuery" class="block text-sm font-medium text-gray-700 mb-2">Enter Medical Query:</label>
                        <textarea id="kbQuery" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition resize-none" placeholder="e.g., What is the standard treatment protocol for stage II non-small cell lung cancer?"></textarea>
                        
                        <button onclick="runKnowledgeBaseSearch()" id="kbSearchButton" class="w-full mt-6 bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition shadow-lg transform hover:scale-[1.01]">
                            Search Medical Knowledge <i data-lucide="search" class="w-4 h-4 ml-2 inline-block"></i>
                        </button>
                        <div id="kbLoadingIndicator" class="mt-4 text-center text-indigo-600 font-medium hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Searching...
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Grounding Results</h3>
                        <div id="kbOutput" class="min-h-[400px] bg-gray-50 p-4 rounded-lg border border-gray-200 overflow-y-auto">
                            <p class="text-gray-500 italic">Results from medical literature searches will appear here, complete with citations.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ======================================================================= -->
            <!-- 3. GENERAL DOCTOR AI VIEW -->
            <!-- ======================================================================= -->
            <div id="doctor-ai-view" class="hidden view-content">
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Conversational AI</h3>
                    
                    <div id="chatHistoryContainer" class="chat-container overflow-y-auto p-4 flex flex-col space-y-4 mb-4 bg-gray-50 rounded-lg border border-gray-200">
                        <!-- Chat messages will be injected here -->
                    </div>

                    <div class="flex items-center space-x-4">
                        <input type="text" id="chatInput" placeholder="Ask a medical question (e.g., Explain the role of TNF-alpha in inflammation)..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                        <button onclick="sendMessage()" id="chatSendButton" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center justify-center disabled:opacity-50" disabled>
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="chatLoadingIndicator" class="mt-2 text-center text-blue-600 font-medium hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        AI is typing...
                    </div>
                </div>
            </div>

            <!-- ======================================================================= -->
            <!-- 4. COMMUNICATION DRAFTING VIEW -->
            <!-- ======================================================================= -->
            <div id="communication-view" class="hidden view-content">
                <div class="lg:grid lg:grid-cols-2 lg:gap-8">
                    <!-- Input Form (Left) -->
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Drafting Parameters</h3>

                        <div class="space-y-4">
                            <div>
                                <label for="draftRecipient" class="block text-sm font-medium text-gray-700">Recipient Type</label>
                                <select id="draftRecipient" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                    <option value="Referring Physician">Referring Physician (Referral/Update)</option>
                                    <option value="Patient">Patient (Follow-up/Education)</option>
                                    <option value="Insurance Company">Insurance Company (Pre-authorization)</option>
                                    <option value="Clinic Administrator">Clinic Administrator (Request/Report)</option>
                                </select>
                            </div>
                            <div>
                                <label for="draftTopic" class="block text-sm font-medium text-gray-700">Communication Topic/Details</label>
                                <textarea id="draftTopic" rows="5" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition resize-none" placeholder="e.g., Patient is J. Doe. Needs urgent consultation for a newly diagnosed renal mass (7cm, left kidney)."></textarea>
                            </div>
                            <div class="flex space-x-4">
                                <div class="flex-1">
                                    <label for="draftUrgency" class="block text-sm font-medium text-gray-700">Urgency</label>
                                    <select id="draftUrgency" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                        <option value="Urgent">Urgent</option>
                                        <option value="Standard">Standard</option>
                                        <option value="Routine">Routine</option>
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <label for="draftFormat" class="block text-sm font-medium text-gray-700">Format/Length</label>
                                    <select id="draftFormat" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                        <option value="Short Email">Short Email</option>
                                        <option value="Detailed Letter">Detailed Letter</option>
                                        <option value="Progress Note">Progress Note</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <button onclick="draftCommunication()" id="draftButton" class="w-full mt-6 bg-teal-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-teal-700 transition shadow-lg transform hover:scale-[1.01]">
                            Generate Draft <i data-lucide="file-text" class="w-4 h-4 ml-2 inline-block"></i>
                        </button>
                        <div id="draftLoadingIndicator" class="mt-4 text-center text-teal-600 font-medium hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-teal-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Drafting communication...
                        </div>
                    </div>
                    <!-- Output Panel (Right) -->
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Generated Draft</h3>
                        <div id="draftOutput" class="min-h-[400px] bg-gray-50 p-4 rounded-lg border border-gray-200 overflow-y-auto whitespace-pre-wrap text-gray-800">
                            <p class="text-gray-500 italic">Configure the parameters and click 'Generate Draft' to create a professional communication.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- End viewContainer -->
    </div> <!-- End main-content -->

    <!-- JavaScript for Firebase, Gemini API Call, and UI Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ====================================================================
        // --- 1. MANDATORY GLOBAL VARIABLES & CONFIGURATION ---
        
        // DO NOT CHANGE THESE VARIABLES - they are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-medical-ai-hub';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- IMPORTANT: PASTE YOUR GEMINI API KEY HERE ---
        const GEMINI_API_KEY = ""; 
        
        const MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`;
        
        let app, db, auth;
        let userId = null;
        let imageBase64Data = null; // Store the Base64 image data globally

        // Chat state for General Doctor AI
        let chatHistory = [{ 
            role: "model", 
            parts: [{ text: "Hello! I am the General Doctor AI. I can help you with medical information, answer questions, or clarify concepts. **I cannot provide diagnosis or personalized medical advice.** How can I assist you today?" }] 
        }];

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const promptInput = document.getElementById('promptInput');
        const imageReportOutput = document.getElementById('imageReportOutput');
        const runButton = document.getElementById('runButton');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const appIdDisplay = document.getElementById('appIdDisplay');
        const errorTitle = document.getElementById('errorTitle');
        const errorDetail = document.getElementById('errorDetail');
        const errorMessage = document.getElementById('errorMessage');
        
        const mainTitle = document.getElementById('mainTitle');
        const viewContainer = document.getElementById('viewContainer');
        const navContainer = document.getElementById('nav-container');

        // ====================================================================
        // --- 2. FIREBASE INITIALIZATION & AUTHENTICATION (MANDATORY) ---
        
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                userIdDisplay.textContent = "Error: No Config";
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                appIdDisplay.textContent = appId;

                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Get User ID and display it
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        // Enable chat input only after auth is ready
                        document.getElementById('chatSendButton').disabled = false;
                        document.getElementById('chatInput').addEventListener('keypress', handleChatInputKeypress);
                    } else {
                        userId = null;
                        userIdDisplay.textContent = "Signed Out";
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                userIdDisplay.textContent = `Auth Error: ${error.code}`;
            }
        }
        
        // ====================================================================
        // --- 3. UI, UTILITY, and NAVIGATION ---
        
        /**
         * Switches the active content view based on the navigation item clicked.
         * @param {string} viewName - The ID suffix of the view to show (e.g., 'image-analysis').
         */
        window.switchView = function(viewName) {
            // Hide all views and remove active class from all nav items
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.add('hidden');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active', 'text-gray-600');
                if (item.getAttribute('data-view') !== viewName) {
                    item.classList.add('text-gray-600');
                }
            });

            // Show the selected view and set active class
            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) {
                targetView.classList.remove('hidden');
                document.querySelector(`.nav-item[data-view="${viewName}"]`).classList.add('active');
                
                // Update the main title
                const titleMap = {
                    'image-analysis': 'AI Image Analysis',
                    'knowledge-base': 'Medical Knowledge Base',
                    'doctor-ai': 'General Doctor AI Chat',
                    'communication': 'Communication Drafting'
                };
                mainTitle.textContent = titleMap[viewName] || 'Medical AI Hub';
            }
        }

        /**
         * Converts file to Base64 and updates UI preview. (Used by Image Analysis)
         */
        window.handleFileSelect = function(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                imageBase64Data = null;
                runButton.disabled = true;
                imagePreviewContainer.classList.add('hidden');
                imagePreview.src = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result;
                imageBase64Data = base64.split(',')[1]; 
                imagePreview.src = base64;
                imagePreviewContainer.classList.remove('hidden');
                runButton.disabled = false;
                console.log(`Image loaded: ${file.name}, MIME Type: ${file.type}`);
            };
            reader.readAsDataURL(file);
        }

        /**
         * Implements exponential backoff for retrying API requests.
         */
        function getBackoffDelay(attempt) {
            return Math.min(30000, (2 ** attempt) * 1000);
        }

        /**
         * Displays a temporary error message in the corner.
         */
        function displayError(title, detail) {
            errorTitle.textContent = title;
            errorDetail.textContent = detail;
            errorMessage.classList.remove('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }
        
        // ====================================================================
        // --- 4. MODULE 1: IMAGE ANALYSIS (Multimodal/Structured Output) ---

        const reportSchema = {
            type: "OBJECT",
            properties: {
                impression: { type: "STRING", description: "The final diagnostic summary or conclusion of the radiological findings." },
                findings: { type: "STRING", description: "Detailed, objective description of the radiological observations." },
                recommendations: { type: "STRING", description: "Suggested follow-up studies, clinical correlation, or patient management steps." }
            },
            required: ["impression", "findings", "recommendations"],
            propertyOrdering: ["impression", "findings", "recommendations"]
        };
        
        function formatReportHtml(reportJson) {
            let html = '';
            const sections = [
                { key: 'impression', title: 'Impression' },
                { key: 'findings', title: 'Findings' },
                { key: 'recommendations', title: 'Recommendations' }
            ];

            for (const section of sections) {
                const content = reportJson[section.key] || 'N/A';
                html += `
                    <div class="report-section">
                        <h4 class="text-lg font-bold text-blue-700 mb-2">${section.title}</h4>
                        <p class="text-gray-800 whitespace-pre-wrap">${content}</p>
                    </div>
                `;
            }
            return html;
        }

        window.runAnalysis = async function() {
            if (!GEMINI_API_KEY) {
                displayError("API Key Missing", "Please paste your Gemini API Key into the GEMINI_API_KEY variable.");
                return;
            }
            if (!imageBase64Data) {
                displayError("No Image Selected", "Please upload a medical image before running the analysis.");
                return;
            }
            
            const prompt = promptInput.value.trim();
            const mimeType = fileInput.files[0].type;
            const loadingIndicator = document.getElementById('imageAnalysisLoadingIndicator');
            
            runButton.disabled = true;
            runButton.innerHTML = 'Analyzing...';
            loadingIndicator.classList.remove('hidden');
            imageReportOutput.innerHTML = `<p class="text-gray-500 italic">Sending image and prompt to AI for structured report generation...</p>`;
            document.getElementById('copyButton').classList.add('hidden');

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: imageBase64Data 
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: reportSchema
                },
                tools: [{ "google_search": {} }]
            };
            
            const maxRetries = 5;
            let attempt = 0;
            
            try {
                // ... (Exponential backoff retry logic as before)
                while (attempt < maxRetries) {
                    attempt++;
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429 && attempt < maxRetries) {
                            const delay = getBackoffDelay(attempt);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        
                        if (!response.ok) {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }

                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            const jsonText = candidate.content.parts[0].text;
                            const reportJson = JSON.parse(jsonText);
                            
                            imageReportOutput.innerHTML = formatReportHtml(reportJson);
                            document.getElementById('copyButton').dataset.reportText = JSON.stringify(reportJson, null, 2);
                            document.getElementById('copyButton').classList.remove('hidden');

                        } else {
                            throw new Error("Empty or malformed AI response received.");
                        }
                        break;
                    } catch (error) {
                        if (attempt === maxRetries) {
                            throw error;
                        }
                        const delay = getBackoffDelay(attempt);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            } catch (error) {
                console.error('Final API Error:', error);
                imageReportOutput.innerHTML = `<p class="text-red-600 font-bold">An error occurred: Failed to generate structured report.</p>`;
                displayError("Analysis Failed", `Check console for details. Error: ${error.message}`);
            } finally {
                runButton.disabled = false;
                runButton.innerHTML = 'Run AI Analysis <i data-lucide="sparkles" class="w-4 h-4 ml-2 inline-block"></i>';
                loadingIndicator.classList.add('hidden');
                lucide.createIcons();
            }
        }

        window.copyReport = function() {
            const copyButton = document.getElementById('copyButton');
            const reportText = copyButton.dataset.reportText;
            if (!reportText) return;

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = reportText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                copyButton.innerHTML = 'Copied!';
                setTimeout(() => {
                    copyButton.innerHTML = 'Copy Report Text (JSON)';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                copyButton.innerHTML = 'Copy Failed!';
            }
            document.body.removeChild(tempTextArea);
        }

        // ====================================================================
        // --- 5. MODULE 2: KNOWLEDGE BASE (Grounding Search) ---

        function formatKbOutput(text, sources) {
            let html = `<div>${text.replace(/\n/g, '<br>')}</div>`;
            if (sources && sources.length > 0) {
                html += '<div class="mt-4 pt-4 border-t border-gray-300">';
                html += '<h5 class="font-semibold text-sm mb-2 text-indigo-700">Cited Sources:</h5>';
                sources.forEach((s, index) => {
                    html += `<p class="text-xs text-gray-600 mb-1">
                        <a href="${s.uri}" target="_blank" class="text-blue-600 hover:underline">
                            ${index + 1}. ${s.title}
                        </a>
                    </p>`;
                });
                html += '</div>';
            }
            return html;
        }

        window.runKnowledgeBaseSearch = async function() {
            if (!GEMINI_API_KEY) {
                displayError("API Key Missing", "Please paste your Gemini API Key.");
                return;
            }
            
            const kbQuery = document.getElementById('kbQuery').value.trim();
            if (!kbQuery) {
                displayError("Empty Query", "Please enter a medical query to search.");
                return;
            }
            
            const kbSearchButton = document.getElementById('kbSearchButton');
            const kbLoadingIndicator = document.getElementById('kbLoadingIndicator');
            const kbOutput = document.getElementById('kbOutput');

            kbSearchButton.disabled = true;
            kbSearchButton.innerHTML = 'Searching...';
            kbLoadingIndicator.classList.remove('hidden');
            kbOutput.innerHTML = `<p class="text-gray-500 italic">Searching medical literature for: "${kbQuery}"...</p>`;

            const payload = {
                contents: [{ parts: [{ text: kbQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "You are a highly knowledgeable medical information specialist. Answer the user's query using information from your search tools. Be concise, precise, and objective." }]
                },
            };
            
            const maxRetries = 5;
            let attempt = 0;

            try {
                 while (attempt < maxRetries) {
                    attempt++;
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429 && attempt < maxRetries) {
                            const delay = getBackoffDelay(attempt);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            const text = candidate.content.parts[0].text;
                            let sources = [];
                            const groundingMetadata = candidate.groundingMetadata;
                            
                            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                                sources = groundingMetadata.groundingAttributions
                                    .map(attribution => ({
                                        uri: attribution.web?.uri,
                                        title: attribution.web?.title,
                                    }))
                                    .filter(source => source.uri && source.title);
                            }
                            
                            kbOutput.innerHTML = formatKbOutput(text, sources);

                        } else {
                            kbOutput.innerHTML = `<p class="text-red-600 font-bold">Error: AI did not return a valid response.</p>`;
                        }
                        break;
                    } catch (error) {
                         if (attempt === maxRetries) {
                            throw error;
                        }
                        const delay = getBackoffDelay(attempt);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            } catch (error) {
                console.error('Final API Error:', error);
                kbOutput.innerHTML = `<p class="text-red-600 font-bold">An error occurred: Failed to search knowledge base.</p>`;
                displayError("Search Failed", `Check console for details. Error: ${error.message}`);
            } finally {
                kbSearchButton.disabled = false;
                kbSearchButton.innerHTML = 'Search Medical Knowledge <i data-lucide="search" class="w-4 h-4 ml-2 inline-block"></i>';
                kbLoadingIndicator.classList.add('hidden');
                lucide.createIcons();
            }
        }

        // ====================================================================
        // --- 6. MODULE 3: GENERAL DOCTOR AI (Conversational Chat) ---

        /**
         * Renders the current chat history to the UI.
         */
        function renderChat() {
            const container = document.getElementById('chatHistoryContainer');
            container.innerHTML = '';
            
            chatHistory.forEach(message => {
                const isUser = message.role === 'user';
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isUser ? 'user-message' : 'ai-message'} ${isUser ? 'text-gray-900' : 'text-gray-700'}`;
                messageDiv.innerHTML = `<p class="${isUser ? 'font-medium' : 'prose text-sm'}">${message.parts[0].text}</p>`;
                container.appendChild(messageDiv);
            });

            // Scroll to the bottom of the chat container
            container.scrollTop = container.scrollHeight;
        }

        function handleChatInputKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        window.sendMessage = async function() {
            if (!GEMINI_API_KEY) {
                displayError("API Key Missing", "Please paste your Gemini API Key.");
                return;
            }

            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            const chatLoadingIndicator = document.getElementById('chatLoadingIndicator');
            const userInput = chatInput.value.trim();

            if (!userInput) return;

            // 1. Add user message to history and UI
            chatHistory.push({ role: "user", parts: [{ text: userInput }] });
            renderChat();
            
            // 2. Clear input and disable
            chatInput.value = '';
            chatInput.disabled = true;
            chatSendButton.disabled = true;
            chatLoadingIndicator.classList.remove('hidden');

            const chatPayload = {
                contents: chatHistory,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "You are a helpful and knowledgeable medical assistant. Provide accurate, non-diagnostic information. Always remind the user that you are an AI and cannot replace a doctor." }]
                }
            };

            const maxRetries = 5;
            let attempt = 0;

            try {
                // ... (Exponential backoff retry logic)
                while (attempt < maxRetries) {
                    attempt++;
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(chatPayload)
                        });

                        if (response.status === 429 && attempt < maxRetries) {
                            const delay = getBackoffDelay(attempt);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }

                        const result = await response.json();
                        const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (responseText) {
                            // 3. Add AI response to history and UI
                            chatHistory.push({ role: "model", parts: [{ text: responseText }] });
                            renderChat();
                        } else {
                            throw new Error("AI did not return a valid response.");
                        }
                        break;
                    } catch (error) {
                        if (attempt === maxRetries) {
                            throw error;
                        }
                        const delay = getBackoffDelay(attempt);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            } catch (error) {
                console.error('Final Chat API Error:', error);
                const errorMessage = "Sorry, I ran into an error. Please try again or refresh the page.";
                chatHistory.push({ role: "model", parts: [{ text: errorMessage }] });
                renderChat();
                displayError("Chat Failed", `Error: ${error.message}`);
            } finally {
                // 4. Re-enable input
                chatInput.disabled = false;
                chatSendButton.disabled = false;
                chatLoadingIndicator.classList.add('hidden');
                chatInput.focus();
                lucide.createIcons();
            }
        }

        // ====================================================================
        // --- 7. MODULE 4: COMMUNICATION DRAFTING ---

        window.draftCommunication = async function() {
            if (!GEMINI_API_KEY) {
                displayError("API Key Missing", "Please paste your Gemini API Key.");
                return;
            }

            const draftRecipient = document.getElementById('draftRecipient').value;
            const draftTopic = document.getElementById('draftTopic').value.trim();
            const draftUrgency = document.getElementById('draftUrgency').value;
            const draftFormat = document.getElementById('draftFormat').value;
            
            if (!draftTopic) {
                displayError("Missing Details", "Please provide the communication topic and details.");
                return;
            }

            const draftButton = document.getElementById('draftButton');
            const draftLoadingIndicator = document.getElementById('draftLoadingIndicator');
            const draftOutput = document.getElementById('draftOutput');

            draftButton.disabled = true;
            draftButton.innerHTML = 'Drafting...';
            draftLoadingIndicator.classList.remove('hidden');
            draftOutput.innerHTML = `<p class="text-gray-500 italic">Generating ${draftFormat} for ${draftRecipient}...</p>`;

            const systemPrompt = "You are a professional medical administrative assistant. Your task is to draft a clear, concise, and professional communication (e.g., referral letter, patient follow-up). Maintain a formal but helpful tone. Only output the letter/email content, no greetings or explanations.";
            const userQuery = `Draft an ${draftUrgency} ${draftFormat} to a "${draftRecipient}". The main topic and details are: "${draftTopic}". Ensure the tone is appropriate for the recipient.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            const maxRetries = 5;
            let attempt = 0;

            try {
                 while (attempt < maxRetries) {
                    attempt++;
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429 && attempt < maxRetries) {
                            const delay = getBackoffDelay(attempt);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (responseText) {
                            draftOutput.innerHTML = responseText.replace(/\n/g, '<br>'); // Preserve line breaks
                        } else {
                            draftOutput.innerHTML = `<p class="text-red-600 font-bold">Error: AI did not return a valid response.</p>`;
                        }
                        break;
                    } catch (error) {
                         if (attempt === maxRetries) {
                            throw error;
                        }
                        const delay = getBackoffDelay(attempt);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            } catch (error) {
                console.error('Final Drafting API Error:', error);
                draftOutput.innerHTML = `<p class="text-red-600 font-bold">An error occurred: Failed to generate communication draft.</p>`;
                displayError("Drafting Failed", `Error: ${error.message}`);
            } finally {
                draftButton.disabled = false;
                draftButton.innerHTML = 'Generate Draft <i data-lucide="file-text" class="w-4 h-4 ml-2 inline-block"></i>';
                draftLoadingIndicator.classList.add('hidden');
                lucide.createIcons();
            }
        }


        // ====================================================================
        // --- 8. INITIALIZATION ON LOAD ---
        
        window.onload = function() {
             // 1. Initialize Firebase services
             initializeFirebase();
             
             // 2. Load icons
             lucide.createIcons();

             // 3. Set up initial views and navigation listeners
             switchView('image-analysis');
             navContainer.addEventListener('click', (e) => {
                 const target = e.target.closest('.nav-item');
                 if (target) {
                     switchView(target.getAttribute('data-view'));
                 }
             });

             // 4. Initialize default prompt
             promptInput.value = "Analyze the image for radiological findings. Provide a structured JSON output with fields 'impression', 'findings', and 'recommendations'. Ensure the impression is concise and the findings are objective.";
             
             // 5. Setup drag-and-drop listener for Image Analysis
             const dropArea = document.getElementById('dropArea');
             ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
             });
             dropArea.addEventListener('drop', handleDrop, false);

             function preventDefaults(e) {
                 e.preventDefault();
                 e.stopPropagation();
             }
             
             function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    fileInput.dispatchEvent(new Event('change'));
                }
             }

             // 6. Initial chat render
             renderChat();
        };

    </script>
</body>
</html>
